late_ming_crisis = {
	monthly_spawn_chance = 100

	# 1. 触发条件
	can_start = {
		current_year >= 1627
		current_year <= 1650
		exists = c:MNG
		# c:MNG = { owns = location:dadu }
		# OR = {
		# 	current_year = 1644  # 1644年游戏开始时自动启动
		# 	c:MNG = { stability < 50 }
		# 	c:MNG = { current_celestial_authority < 50 } # Assuming this trigger exists for Mandate
		# 	c:MNG = { is_at_war_with = c:QNG }
		# 	c:MNG = { is_at_war_with = c:CSH }
		# }
	}

	# 2. 结束条件
	can_end = {
		current_year > 1650
		# OR = {
		# 	NOT = { exists = c:MNG }
		# 	AND = {
		# 		exists = c:MNG
		# 		c:MNG = {
		# 			stability > 50
		# 			owns = location:dadu
		# 			at_war = no
		# 		}
		# 	}
		# 	AND = {
		# 		exists = c:QNG
		# 		c:QNG = {
		# 			owns = location:dadu
		# 			stability > 50
		# 		}
		# 	}
		# 	AND = {
		# 		exists = c:CSH
		# 		c:CSH = {
		# 			owns = location:dadu
		# 			stability > 50
		# 		}
		# 	}
		# }
	}

	# 3. 可见性 - 对所有首都在中国和满洲的国家可见
	visible = {
		OR = {
			capital.region = region:west_china_region
			capital.region = region:east_china_region
			capital.region = region:north_china_region
			capital.region = region:south_china_region
			capital.region = region:manchuria_region
		}
	}

	# 4. 启动效果
	on_start = {
		# 触发事件给相关国家
		every_country = {
			limit = {
				exists = capital
				OR = {
					capital.region = region:west_china_region
					capital.region = region:east_china_region
					capital.region = region:north_china_region
					capital.region = region:south_china_region
					capital.region = region:manchuria_region
				}
			}
			trigger_event_non_silently = late_ming_crisis.1
		}
		# 初始化变量
		set_global_variable = {
			name = ming_collapse_progress
			value = 0
		}
		# 给所有首都在中国和满洲的国家互相添加"统一中国"CB
		# 使用全局变量列表方法，分两步执行
		zzz_1644_collect_china_countries_effect = yes
		zzz_1644_add_china_cb_effect = yes
	}

	# 5. 月度逻辑
	on_monthly = {
		# 随机事件逻辑，通过事件文件处理
		# 这里可以调用一个统一的脉冲事件
		random_list = {
			10 = { # 10% 概率触发随机事件
				every_country = {
					limit = {
						OR = {
							capital.region = region:west_china_region
							capital.region = region:east_china_region
							capital.region = region:north_china_region
							capital.region = region:south_china_region
							capital.region = region:manchuria_region
						}
					}
					trigger_event_non_silently = late_ming_crisis.100 # Generic monthly pulse event
				}
			}
			90 = {}
		}
	}


}
